# nx-code-coverage github action
This is a github action for combining/compiling lcov code coverage from an nx monorepo (although will probably work for other mono/single repos).
  - This will loop through the coverage folder which should contain all the projects and their coverage results (lcov.info).
  - On a PR execution, this will update the PR with a PR Commit displaying the coverage results for those projects
  - On a push execution, this will update coverage badges for all projects (using the gist method specified [here](https://dev.to/thejaredwilcurt/coverage-badge-with-github-actions-finally-59fa)

> [GitHub Action](https://help.github.com/en/actions) to combine/compile lcov code coverage from an nx monorepo 

-   ✅ &nbsp;Code coverage comment for monorepo
-   ✅ &nbsp;Code coverage diff if base lcov provided
-   ✅ &nbsp;Updates the Code coverage comment instead of adding new

The report is based on the lcov coverage report generated by your test runner.

## Inputs


## Setup
- Perform gist setup from https://dev.to/thejaredwilcurt/coverage-badge-with-github-actions-finally-59fa
- Must run nx:affected test --coverage so the coverage results already exist
```
- name: Test With Coverage (Nx Affected)
  uses: mansagroup/nrwl-nx-action@v2
  with:
    targets: test
    affected: 'true'
    nxCloud: 'false'
    args: '--coverage --coverageReporters=lcov'
```
- Can save artifact of coverage to be used as a base for diff check in next runs
```
# This should exist in workflow that runs after push to main
- name: Archive code coverage results
  uses: actions/upload-artifact@v2
  with:
    name: code-coverage-report
    path: ./coverage/**/lcov.info
    if-no-files-found: error

# This should exist in workflow that runs on a PR to main
- name: Download artifact (base code coverage results)
  uses: dawidd6/action-download-artifact@v2
  id: restoreCodeCoverage
  continue-on-error: true # first run or any run after archive expiration, artifact will not exist
  with:
    # TODO: update this main workflow
    workflow: pull-request.yaml
    workflow_conclusion: success
    # TODO: update this main workflow
    branch: cicd
    name: code-coverage-report
    # Optional, directory where to extract artifact. Defaults to the artifact name (see `name` input)
    path: ./coverage/base
    # Optional, defaults to current repo
    repo: ${{github.repository}}
```


## Acknowledgements
Thanks to the creators of the code that this was based on 

  - [eeshdarthvader/code-coverage-assistant](https://github.com/eeshdarthvader/code-coverage-assistant)
  - [romeovs/lcov-reporter-action](https://github.com/romeovs/lcov-reporter-action).
  - [ziishaned/jest-reporter-action](https://github.com/ziishaned/jest-reporter-action)
  - [slavcodev/coverage-monitor-action](https://github.com/slavcodev/coverage-monitor-action)

## License

[MIT](LICENSE)




## Change action.yml

The action.yml defines the inputs and output for your action.

Update the action.yml with your name, description, inputs and outputs for your action.

See the [documentation](https://help.github.com/en/articles/metadata-syntax-for-github-actions)



## Publish to a distribution branch

Actions are run from GitHub repos so we will checkin the packed dist folder. 

Then run [ncc](https://github.com/zeit/ncc) and push the results:
```bash
$ npm run package
$ git add dist
$ git commit -a -m "prod dependencies"
$ git push origin releases/v1
```

Note: We recommend using the `--license` option for ncc, which will create a license file for all of the production node modules used in your project.

Your action is now published! :rocket: 

See the [versioning documentation](https://github.com/actions/toolkit/blob/master/docs/action-versioning.md)

## Validate

You can now validate the action by referencing `./` in a workflow in your repo (see [test.yml](.github/workflows/test.yml))

```yaml
uses: ./
with:
  milliseconds: 1000
```

See the [actions tab](https://github.com/actions/typescript-action/actions) for runs of this action! :rocket:

## Usage:

After testing you can [create a v1 tag](https://github.com/actions/toolkit/blob/master/docs/action-versioning.md) to reference the stable and latest V1 action
